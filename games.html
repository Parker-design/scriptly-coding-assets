<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Scriptly Coding</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <canvas id="particles"></canvas>

  <!-- Navbar -->
  <nav>
    <img src="https://cdn.jsdelivr.net/gh/Parker-design/scriptlycoding@2ba694fbf370a8e1372bb02f0b604348c01fe64f/logo.png"
         onclick="window.location='index.html'" class="logo">

    <!-- Games link in center (jsDelivr placeholder) -->
    <a href="https://cdn.jsdelivr.net/gh/your-username/your-repo/games.html" class="nav-center-link">Games</a>

    <div class="profile-menu">
      <img id="profile-icon" src="https://cdn.jsdelivr.net/gh/Parker-design/scriptlycoding@2ba694fbf370a8e1372bb02f0b604348c01fe64f/profile.webp"
           onclick="toggleDropdown()" class="profile-icon">
      <div id="dropdown-menu" class="dropdown"></div>
    </div>
  </nav>

  <!-- Templates -->
  <div class="templates-container" id="templates-container">
    <div class="template-card">
      <img src="https://cdn.jsdelivr.net/gh/Parker-design/scriptlycoding@2ba694fbf370a8e1372bb02f0b604348c01fe64f/html-icon.png" class="icon-html">
      <h3>HTML Project</h3>
      <button onclick="openTemplate('index.html')">Use This</button>
    </div>

    <div class="template-card">
      <img src="https://cdn.jsdelivr.net/gh/Parker-design/scriptlycoding@2ba694fbf370a8e1372bb02f0b604348c01fe64f/python-icon.png" class="icon-python">
      <h3>Python Project</h3>
      <button onclick="openTemplate('main.py')">Use This</button>
    </div>

    <div class="template-card">
      <img src="https://cdn.jsdelivr.net/gh/Parker-design/scriptlycoding@2ba694fbf370a8e1372bb02f0b604348c01fe64f/blank-icon%20(1)%20(1).png" class="icon-blank">
      <h3>Blank Project</h3>
      <button onclick="openTemplate('blank.js')">Use This</button>
    </div>

    <!-- New Template card -->
    <div class="template-card add-template-card" onclick="addNewTemplate()">
      <img src="https://cdn-icons-png.flaticon.com/512/1828/1828817.png" class="icon-plus">
      <h3>New Template</h3>
    </div>
  </div>

  <!-- Recent Codespaces -->
  <div class="templates-container" id="recent-container">
    <h2>Recent Codespaces</h2>
    <div id="recent-list"></div>
  </div>

  <!-- Modal -->
  <div id="app-modal" class="modal">
    <div class="modal-content">
      <h3 id="modal-message">Message here</h3>
      <button onclick="closeModal()">OK</button>
    </div>
  </div>

  <!-- Scripts -->
  <script src="particles.js"></script>
  <script>
    function showModal(message) {
      const modal = document.getElementById("app-modal");
      document.getElementById("modal-message").textContent = message;
      modal.style.display = "flex";
    }
    function closeModal() {
      document.getElementById("app-modal").style.display = "none";
    }

    function toggleDropdown() {
      const menu = document.getElementById("dropdown-menu");
      menu.classList.toggle("show");
      renderDropdown();
    }

    function renderDropdown() {
      const menu = document.getElementById("dropdown-menu");
      const loggedIn = localStorage.getItem("loggedIn") === "true";
      menu.innerHTML = "";

      if (loggedIn) {
        const settingsBtn = document.createElement("button");
        settingsBtn.textContent = "Settings";
        settingsBtn.onclick = () => window.location = "settings.html";

        const logoutBtn = document.createElement("button");
        logoutBtn.textContent = "Log Out";
        logoutBtn.onclick = async () => {
          localStorage.setItem("loggedIn", "false");
          localStorage.removeItem("currentUser");
          try { await window.firebaseSignOut(); } catch {}
          renderDropdown();
          updateProfileIcon();
        };

        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "Delete Account";
        deleteBtn.className = "delete-btn";
        deleteBtn.onclick = deleteAccount;

        menu.appendChild(settingsBtn);
        menu.appendChild(logoutBtn);
        menu.appendChild(deleteBtn);
      } else {
        const signinBtn = document.createElement("button");
        signinBtn.textContent = "Sign In";
        signinBtn.onclick = () => window.location = "signin.html";

        const signupBtn = document.createElement("button");
        signupBtn.textContent = "Create Account";
        signupBtn.onclick = () => window.location = "signup.html";

        menu.appendChild(signinBtn);
        menu.appendChild(signupBtn);
      }
    }

    function updateProfileIcon() {
      const icon = document.getElementById("profile-icon");
      const user = localStorage.getItem("currentUser");
      if (icon && user) {
        const pic = localStorage.getItem("profilePic:" + user);
        if (pic) icon.src = pic;
      }
    }

    function openTemplate(tplName) {
      const user = localStorage.getItem("currentUser");
      if (!user) {
        showModal("Sign in to use templates.");
        return;
      }
      const key = "codespace:" + user + ":" + tplName;
      if (!localStorage.getItem(key)) {
        let starter = "";
        if (tplName.endsWith(".html")) {
          starter = "<!DOCTYPE html>\\n<html>\\n<head><meta charset='utf-8'><title>Starter</title></head>\\n<body>\\n<h1>New HTML Template</h1>\\n</body>\\n</html>";
        } else if (tplName.endsWith(".py")) {
          starter = "# Starter Python file\\nprint('Hello from template')\\n";
        } else {
          starter = "// Starter file\\nconsole.log('Hello from template');\\n";
        }
        localStorage.setItem(key, starter);
      }
      window.location = "codespace.html?template=" + encodeURIComponent(tplName);
    }

    function renderRecent() {
      const container = document.getElementById("recent-list");
      container.innerHTML = "";
      const user = localStorage.getItem("currentUser");
      if (!user) {
        container.innerHTML = "<p style='color:#999;'>Sign in to see recent codespaces.</p>";
        return;
      }
      const recents = [];
      Object.keys(localStorage).forEach(k => {
        if (k.startsWith("codespace:" + user + ":")) {
          recents.push(k.split(":")[2]);
        }
      });
      if (!recents.length) {
        container.innerHTML = "<p style='color:#999;'>No recent codespaces.</p>";
        return;
      }
      recents.slice(-5).forEach(name => {
        const card = document.createElement("div");
        card.className = "template-card";
        card.innerHTML = "<h3>" + name + "</h3>";
        const btn = document.createElement("button");
        btn.textContent = "Open";
        btn.onclick = () => window.location = "codespace.html?template=" + encodeURIComponent(name);
        card.appendChild(btn);
        container.appendChild(card);
      });
    }

    function deleteAccount() {
      const currentUser = localStorage.getItem("currentUser");
      if (!currentUser) { showModal("No user signed in."); return; }
      if (!confirm("Are you sure you want to delete your account?")) return;

      localStorage.removeItem("user:" + currentUser);
      localStorage.removeItem("profilePic:" + currentUser);
      Object.keys(localStorage).forEach(k => {
        if (k.startsWith("codespace:" + currentUser + ":")) {
          localStorage.removeItem(k);
        }
      });
      localStorage.setItem("loggedIn", "false");
      localStorage.removeItem("currentUser");
      showModal("Your account has been deleted.");
      setTimeout(() => window.location = "index.html", 1000);
    }

    function addNewTemplate() {
      const user = localStorage.getItem("currentUser");
      if (!user) {
        showModal("Sign in to add templates.");
        return;
      }
      const input = document.createElement("input");
      input.type = "file";
      input.onchange = e => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = ev => {
          const content = ev.target.result;
          localStorage.setItem("codespace:" + user + ":" + file.name, content);
          showModal("Template added!");
          renderRecent();
        };
        reader.readAsText(file);
      };
      input.click();
    }

    window.addEventListener("DOMContentLoaded", () => {
      renderDropdown();
      updateProfileIcon();
      renderRecent();
      if (localStorage.getItem("particlesEnabled") !== "false") {
        initParticles();
      }
    });

    // Handle updates from settings (premade templates)
    window.addEventListener("templatesUpdated", () => {
      renderRecent();
    });
  </script>

  <!-- Firebase sync -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAJPIS3a4-NGnGL6sQfqFxTpEA7GZKR4hY",
      authDomain: "scriptlycoding.firebaseapp.com",
      projectId: "scriptlycoding",
      storageBucket: "scriptlycoding.firebasestorage.app",
      messagingSenderId: "481695232530",
      appId: "1:481695232530:web:83b73976803d53a1659ecb",
      measurementId: "G-FRETY7JE0G"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    onAuthStateChanged(auth, (user) => {
      if (user) {
        localStorage.setItem("loggedIn","true");
        localStorage.setItem("currentUser", user.email);
      } else {
        localStorage.setItem("loggedIn","false");
        localStorage.removeItem("currentUser");
      }
      if (typeof renderDropdown === "function") renderDropdown();
      if (typeof updateProfileIcon === "function") updateProfileIcon();
      if (typeof renderRecent === "function") renderRecent();
    });

    window.firebaseSignOut = async function() {
      try { await signOut(auth); } catch(e) { console.warn("Firebase signOut failed:", e); }
    };
  </script>
</body>
</html>
